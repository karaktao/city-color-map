api_fetch\fetch_images.py:3:ä» Mapillary Graph API æ‰¹é‡è·å–è¡—æ™¯å›¾ç‰‡å…ƒæ•°æ®ï¼Œå¹¶æŠŠæ¯ä¸€é¡µçš„ JSON
api_fetch\fetch_images.py:22:# å¦‚æœå®Œå…¨æ²¡æœ‰ bbox é…ç½®æ—¶çš„â€œå…œåº•é»˜è®¤å€¼â€
api_fetch\fetch_images.py:24:DEFAULT_BBOX = "6.865833,52.205278,6.917778,52.233889"
api_fetch\fetch_images.py:27:LIMIT = 3000  # ä¸ºäº†ä¿æŒè¾“å‡ºæ–‡ä»¶åä¸€è‡´ï¼Œè¿™é‡Œä¸æ”¹ï¼›ä½†æ›´ç¨³çš„å»ºè®®æ˜¯ 500~2000
api_fetch\fetch_images.py:28:BASE_URL = "https://graph.mapillary.com/images"
api_fetch\fetch_images.py:62:def parse_bbox_code(code: str) -> str:
api_fetch\fetch_images.py:71:       ä»æ‰€æœ‰ç‚¹é‡Œå– min/max ç»„æˆ bbox
api_fetch\fetch_images.py:73:    è¿”å›åè¿›åˆ¶ bbox å­—ç¬¦ä¸²: "west,south,east,north"
api_fetch\fetch_images.py:76:        raise ValueError("ç©ºçš„ BBOX_CODE")
api_fetch\fetch_images.py:107:    raise ValueError("BBOX_CODE æ ¼å¼ä¸å®Œæ•´æˆ–ä¸æ”¯æŒçš„æ ¼å¼")
api_fetch\fetch_images.py:110:def _resolve_bbox_from_project(project_dir: Path) -> str:
api_fetch\fetch_images.py:112:    ä»é¡¹ç›®ç›®å½•è¯»å– config.json ä¸­çš„ bbox / bbox_codeï¼Œ
api_fetch\fetch_images.py:113:    å¦‚æœæ²¡æœ‰æˆ–è§£æå¤±è´¥ï¼Œåˆ™å›é€€åˆ° DEFAULT_BBOXã€‚
api_fetch\fetch_images.py:118:    bbox = DEFAULT_BBOX
api_fetch\fetch_images.py:125:            print(f"[WARN] æ— æ³•è¯»å– {config_path}ï¼Œä½¿ç”¨é»˜è®¤ bbox. é”™è¯¯: {e}")
api_fetch\fetch_images.py:126:            return bbox
api_fetch\fetch_images.py:128:        cfg_bbox = (config.get("bbox") or "").strip()
api_fetch\fetch_images.py:129:        cfg_code = (config.get("bbox_code") or "").strip()
api_fetch\fetch_images.py:131:        if cfg_bbox:
api_fetch\fetch_images.py:132:            print(f"[INFO] ä» {config_path} è¯»å–åè¿›åˆ¶ bbox = {cfg_bbox}")
api_fetch\fetch_images.py:133:            return cfg_bbox
api_fetch\fetch_images.py:136:            print(f"[INFO] ä» {config_path} è¯»å– bbox_codeï¼Œå°è¯•è§£æ...")
api_fetch\fetch_images.py:138:                parsed = parse_bbox_code(cfg_code)
api_fetch\fetch_images.py:139:                print(f"[INFO] bbox_code è§£ææˆåŠŸ: {parsed}")
api_fetch\fetch_images.py:142:                print(f"[WARN] bbox_code è§£æå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤ bbox. é”™è¯¯: {e}")
api_fetch\fetch_images.py:144:        print(f"[INFO] config.json ä¸­æ²¡æœ‰æœ‰æ•ˆ bboxï¼Œä½¿ç”¨é»˜è®¤ DEFAULT_BBOX = {bbox}")
api_fetch\fetch_images.py:145:        return bbox
api_fetch\fetch_images.py:147:    print(f"[INFO] æœªæ‰¾åˆ° {config_path}ï¼Œä½¿ç”¨é»˜è®¤ DEFAULT_BBOX = {bbox}")
api_fetch\fetch_images.py:148:    return bbox
api_fetch\fetch_images.py:153:def _parse_bbox_str(bbox: str):
api_fetch\fetch_images.py:154:    w, s, e, n = [float(x.strip()) for x in bbox.split(",")]
api_fetch\fetch_images.py:156:        raise ValueError(f"bbox ä¸åˆæ³•ï¼š{bbox}")
api_fetch\fetch_images.py:160:def _format_bbox(w: float, s: float, e: float, n: float) -> str:
api_fetch\fetch_images.py:164:def _tile_bboxes(big_bbox: str, tile_size: float, overlap_ratio: float):
api_fetch\fetch_images.py:166:    å¤§ bbox -> å¤šä¸ªå° bboxï¼ˆtileï¼‰ï¼Œå¸¦å°‘é‡é‡å é¿å…è¾¹ç•Œæ¼å›¾ã€‚
api_fetch\fetch_images.py:168:    w, s, e, n = _parse_bbox_str(big_bbox)
api_fetch\fetch_images.py:180:            tiles.append(_format_bbox(x, y, x2, y2))
api_fetch\fetch_images.py:199:                retry_after = resp.headers.get("Retry-After")
api_fetch\fetch_images.py:200:                sleep_s = float(retry_after) if retry_after else (BACKOFF_BASE_SECONDS * (2 ** (attempt - 1)))
api_fetch\fetch_images.py:220:def _fetch_images_core(raw_dir: Path, bbox: str):
api_fetch\fetch_images.py:222:    å®é™…æŠ“å– Mapillary æ•°æ®çš„æ ¸å¿ƒå‡½æ•°ï¼ˆå‡çº§ï¼štile æ¨¡å¼ï¼Œä½†è¾“å…¥è¾“å‡ºä¿æŒä¸€è‡´ï¼‰ã€‚
api_fetch\fetch_images.py:224:    bbox:   "west,south,east,north"
api_fetch\fetch_images.py:228:    - æ–‡ä»¶åä»ç„¶æ˜¯ï¼šimages_bbox_{big_bbox_safe}_limit{LIMIT}_page{page}.json
api_fetch\fetch_images.py:232:    big_bbox = bbox
api_fetch\fetch_images.py:233:    big_bbox_safe = big_bbox.replace(",", "_")
api_fetch\fetch_images.py:236:    tiles = _tile_bboxes(big_bbox, tile_size=TILE_SIZE_DEG, overlap_ratio=TILE_OVERLAP_RATIO)
api_fetch\fetch_images.py:237:    print(f"[INFO] å¼€å§‹æŠ“å– Mapillary æ•°æ®ï¼ˆtile æ¨¡å¼ï¼‰ï¼Œbig_bbox={big_bbox}")
api_fetch\fetch_images.py:244:    for t_idx, tile_bbox in enumerate(tiles, start=1):
api_fetch\fetch_images.py:245:        after_cursor = None
api_fetch\fetch_images.py:249:            "bbox": tile_bbox,
api_fetch\fetch_images.py:251:            "limit": LIMIT,
api_fetch\fetch_images.py:254:        print(f"[INFO] TILE {t_idx}/{len(tiles)} bbox={tile_bbox}")
api_fetch\fetch_images.py:257:            if after_cursor:
api_fetch\fetch_images.py:258:                params["after"] = after_cursor
api_fetch\fetch_images.py:259:            elif "after" in params:
api_fetch\fetch_images.py:260:                params.pop("after")
api_fetch\fetch_images.py:277:            # âœ… è¾“å‡ºæ–‡ä»¶åï¼šä¿æŒåŸæ¥çš„é£æ ¼ï¼ˆä½¿ç”¨ big_bboxï¼Œè€Œä¸æ˜¯ tile_bboxï¼‰
api_fetch\fetch_images.py:279:            out_path = raw_dir / f"images_bbox_{big_bbox_safe}_limit{LIMIT}_page{current_page}.json"
api_fetch\fetch_images.py:288:            paging = data.get("paging", {})
api_fetch\fetch_images.py:289:            after_cursor = paging.get("cursors", {}).get("after")
api_fetch\fetch_images.py:290:            if not after_cursor:
api_fetch\fetch_images.py:305:    - ä» config.json è¯»å– bbox/bbox_code
api_fetch\fetch_images.py:312:    bbox = _resolve_bbox_from_project(project_dir)
api_fetch\fetch_images.py:313:    _fetch_images_core(raw_dir, bbox)
api_fetch\fetch_images.py:321:    - ä½¿ç”¨ DEFAULT_BBOX
api_fetch\fetch_images.py:323:    print("[INFO] ä»¥è„šæœ¬æ–¹å¼è¿è¡Œ fetch_images.pyï¼Œä½¿ç”¨å…¨å±€ RAW_DIR å’Œ DEFAULT_BBOX")
api_fetch\fetch_images.py:324:    _fetch_images_core(GLOBAL_RAW_DIR, DEFAULT_BBOX)
api_main.py:46:class BBoxBody(BaseModel):
api_main.py:48:    bbox_code: str
api_main.py:81:        "bbox": None,
api_main.py:82:        "bbox_code": None,
api_main.py:91:    # 1. æ£€æŸ¥ BBOX (config.json)
api_main.py:97:                status["bbox"] = cfg.get("bbox")
api_main.py:98:                status["bbox_code"] = cfg.get("bbox_code")
api_main.py:130:# ---------- API 2ï¼šè§£æ BBOX code ----------
api_main.py:131:@app.post("/api/set-bbox")
api_main.py:132:def set_bbox(body: BBoxBody):
api_main.py:135:    bbox = fetch_images.parse_bbox_code(body.bbox_code)
api_main.py:136:    config = {"bbox_code": body.bbox_code, "bbox": bbox}
api_main.py:139:    return {"ok": True, "bbox": bbox}
api_main.py:148:        yield f"[INFO] ğŸš€ å¼€å§‹è¯·æ±‚ Mapillary API è·å–å…ƒæ•°æ®...\n"
preprocess\parse_json.py:25:        # Mapillary ä¸€èˆ¬æ˜¯ [lon, lat]
